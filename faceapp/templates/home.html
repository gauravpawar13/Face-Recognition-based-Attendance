{% extends 'base.html' %}
{% load static %}

{% block content %}
  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">Courses</div>
        <div class="card-body">
          <ul class="list-group">
            {% for course in courses %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ course.course_name }}
              {% if selected_course == course.course_id %}
              <button class="btn btn-primary btn-sm" disabled>Selected</button>
              {% else %}
              <a href="{% url 'home' %}?course_id={{ course.course_id }}" class="btn btn-primary btn-sm select-course-btn">Select Course</a>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">Enrollments</div>
        <div class="card-body">
          {% if selected_course %}
            <h5>Students of {{ selected_course_name }}:</h5>
            {% if students %}
              <table class="table">
                <thead>
                  <tr>
                    <th>Student ID</th>
                    <th>Name</th>
                  </tr>
                </thead>
                <tbody>
                  {% for student in students %}
                  <tr>
                    <td>{{ student.student_id }}</td>
                    <td>{{ student.name }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
              <button class="btn btn-primary" id="start-attendance">Start Attendance</button>
              <button class="btn btn-danger" id="stop-attendance" disabled>Show Attendance</button>
            {% else %}
              <p>No students enrolled in this course.</p>
            {% endif %}
          {% else %}
            <p>Please select a course to start attendance.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="container" id="attendance-sheet" style="display:block;">
    <div class="row mt-5">
      <div class="col-md-8 offset-md-2">
        <h2 class="text-center mb-4">Attendance Sheet</h2>
        <table class="table table-striped">
          <thead>
            <tr>
              <th scope="col">Student ID</th>
              <th scope="col">Name</th>
            </tr>
          </thead>
          <tbody>
            {% for student in nameList %}
              <tr>
                <td>{{ student }}</td>
                <td>{{ student }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  
  <h3 id="testjs">Test here</h3>
{% endblock %}

{% block js %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // Get the CSRF token from the cookie
    const csrftoken = document.cookie.match(/csrftoken=([\w-]+)/)[1];

    // Set the CSRF token in the AJAX request headers
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
      }
    });
    const startAttendanceButton = document.getElementById('start-attendance');
    const stopAttendanceButton = document.getElementById('stop-attendance');

    // Start the webcam when the Start Attendance button is clicked
    startAttendanceButton.addEventListener('click', () => {
      startAttendanceButton.disabled = true;
      var courseid='{{selected_course}}'
      $.ajax({
        url: '/take_attendance/',
        type: 'POST',
        data: {action: 'start',course_id:courseid},
        success: function(response) {
          console.log("Closed the camera");
          stopAttendanceButton.disabled = false;
          document.getElementById("testjs").innerHTML=response["success"]
        },
        error: function(xhr, status, error) {
          console.log(xhr.responseText);
        }
      });
    });

    // Stop the webcam when the Stop Attendance button is clicked
    stopAttendanceButton.addEventListener('click', () => {
      startAttendanceButton.disabled = false;

      stopAttendanceButton.disabled = true;
      $.ajax({
        url: '/take_attendance/',
        type: 'POST',
        data: {action: 'stop'},
        success: function(response) {
          console.log(response.message);
        },
        error: function(xhr, status, error) {
          console.log(xhr.responseText);
        }
      });
    });
    
  </script>
{% endblock %}

